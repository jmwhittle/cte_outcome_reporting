---
title: "Career and Technical Edcuation wage outcomes"
author: ""
date: "Last wage update 01/10/2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This application is designed to present current data on Salt Lake Community College's Career and Technical Education programs (CTE). The wage data is obtained from Utah's Department of Workforce Services (DWS) every semester. The wage data is not real time and lags behind between one and two financial quarters. 

```{sql, echo=FALSE, eval=FALSE}
 <!-- initial data request 01/04/2018 -->
 <!-- All students who received an award that was flagged as a "CTE" award from 201140-201740 who have no transfer history since or continued for credit enrollment.  -->

SELECT 
        b.PIDM, 
        b.QUARTER as YEAR_QUARTER,
        b.WAGES,
        c.TERM_CODE,
        d.COLLEGE,
        d.PROGRAM_NAME,
        d.DEGREE_CODE
FROM wsrpmgr.dim_student        A
JOIN wsrpmgr.fact_student_wages B
    ON a.DIM_STUDENT_KEY = b.DIM_STUDENT_KEY
JOIN wsrpmgr.fact_slcc_awards   C
    ON a.DIM_STUDENT_KEY = c.DIM_STUDENT_KEY
JOIN wsrpmgr.dim_program_of_study D
    ON C.DIM_PROGRAM_OF_STUDY_KEY = d.DIM_PROGRAM_OF_STUDY_KEY
JOIN (select pidm
            ,max(enrolled_ind) as TRANSFER_IND 
            from wsrpmgr.fact_post_grad_transfers
            where years_since_slcc_award in ('1', '2')
            group by pidm) E  --Join to a query of students who have transferred
    ON A.pidm = E.pidm
WHERE TRANSFER_IND = 'N'  --They did not transfer to another institution after their award
AND d.cte_ind = 'Y';       --had gotten a CTE award
<!-- AND  B.PIDM NOT IN (select unique A.pidm  --List of students who engaged in degree-seeking behavior in the 2 years following their award  -->
<!--         from wsrpmgr.fact_slcc_awards A -->
<!--         LEFT JOIN wsrpmgr.dim_student_Term B -->
<!--            ON a.PIDM = B.PIDM -->
<!--         LEFT JOIN wsrpmgr.dim_program_of_study C -->
<!--            ON a.dim_program_of_study_key = C.dim_program_of_study_key -->
<!--         WHERE B.term_code > A.term_code       --Only analyze terms that are after their award term.  -->
<!--         AND B.term_code <=(A.term_code+200) --Only care about degree-seeking within 2 years of their award.  -->
<!--         AND B.degree_seeking_code <>0        --filter them out if degree-seeking -->
<!--         ) -->
<!-- order by pidm; -->

 <!-- Also need to know if the DWS data is updated for these PIDMs.  -->

 <!-- might add additional student demographics to this list later. Might be a problem with the "cte flag" element. I can work with just "all awards".  -->
```


```{r, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
# https://higheredutah.org/data/utah-wage-information/ similar information but not as grainular as this app. 
library(shiny)
library(tidyverse); theme_set(theme_minimal())

data <- read_csv("cte_test.csv")

data$wage_year <- substr(data$YEAR_QUARTER, 1,4)
data$wage_qtr<- substr(data$YEAR_QUARTER, 5, 5)
data$aw_year <- substr(data$TERM_CODE, 1, 4)
data$aw_term  <- substr(data$TERM_CODE, 5, 6)

data <- data %>% filter(aw_term == "40" | aw_term == "30" | aw_term == "20")

# 12-24 month wage ifelse. These functions are supposed to take the year and semester a student
# graduated in and then create 4 wage object for pulling the right DWS data yrqtr out for the student
data$wage1 <- as.numeric(
  ifelse(data$aw_term == "40", paste((as.numeric(data$aw_year) + 2), 1, sep = ""), 
         ifelse(data$aw_term == "30", paste((as.numeric(data$aw_year) + 1), 4, sep = ""),
                paste((as.numeric(data$aw_year) + 1), 3, sep = "")
                     )))

data$wage2 <- as.numeric(
  ifelse(data$aw_term == "40", paste((as.numeric(data$aw_year) + 2), 2, sep = ""), 
         ifelse(data$aw_term == "30", paste((as.numeric(data$aw_year) + 2), 1, sep = ""),
                paste((as.numeric(data$aw_year) + 1), 4, sep = "")
                     )))

data$wage3 <- as.numeric(
  ifelse(data$aw_term == "40", paste((as.numeric(data$aw_year) + 2), 3, sep = ""), 
         ifelse(data$aw_term == "30", paste((as.numeric(data$aw_year) + 2), 2, sep = ""),
                paste((as.numeric(data$aw_year) + 2), 1, sep = "")
                     )))

data$wage4<- as.numeric(
  ifelse(data$aw_term == "40", paste((as.numeric(data$aw_year) + 2), 4, sep = ""), 
         ifelse(data$aw_term == "30", paste((as.numeric(data$aw_year) + 2), 3, sep = ""),
                paste((as.numeric(data$aw_year) + 2), 2, sep = "")
                     )))
```

## SLCC CTE workforce outcomes

Start by selecting one college then select one or more programs to evaluate and compare by award level. All wage data is meant to represent starting wages for a student (12-24 months after their award). The wage distribution plot illustrates the spread of wages obtained from DWS by program. The Award Time Series plot displays the awards per academic year by program. The Wage Time Series plot displays the starting wages of various graduating cohorts through time by program. The Awards table provides summarized numbers for the data used to make the plots by Award year and program. 

```{r set-options, echo=FALSE, warning=FALSE, message=FALSE}

# Define UI for application
ui <- fluidPage(
  
  sidebarLayout(
    sidebarPanel(
  selectInput(inputId = "college_ind", label = "College", multiple = FALSE, choices = unique(data$COLLEGE)),
  uiOutput("program"),
  uiOutput("award")
  ),
  
  mainPanel(
    tabsetPanel(
      tabPanel("Wage Distribution", plotOutput(outputId = "plot", width = "100%")),
      tabPanel("Awards Time Series", plotOutput(outputId = "plot_ts", width = "100%")),
      tabPanel("Wage Time Series", plotOutput(outputId = "wage_ts", width = "100%")),
      tabPanel("Awards table", tableOutput(outputId = "table"))
            ))
)) 

# Define server logic required to draw a histogram
server <- function(input, output) {
  df0 <- eventReactive(input$college_ind, {
    data %>% dplyr::filter(COLLEGE %in% input$college_ind)
  })

  output$program <- renderUI({
    selectInput(inputId = "program", label = "Program", multiple = TRUE, choices = unique(df0()$PROGRAM_NAME))
  })
  
  df1 <- eventReactive(input$program, {
    df0() %>% dplyr::filter(PROGRAM_NAME %in% input$program)
  })
  
  output$award <- renderUI({
    selectInput(inputId = "award", label = "Award level", multiple = TRUE, choices = unique(df1()$DEGREE_CODE))
  })

  df2 <- eventReactive(input$award, {
    df1() %>% dplyr::filter(DEGREE_CODE %in% input$award)
  })
  
  output$plot <- renderPlot({
    df2() %>% filter(TERM_CODE > 200940) %>%
      filter(YEAR_QUARTER == wage1 | YEAR_QUARTER == wage2 | YEAR_QUARTER == wage3 | YEAR_QUARTER == wage4) %>% 
      group_by(PIDM) %>%
      filter(max(YEAR_QUARTER) >= wage4) %>%
      group_by(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term) %>%
      summarise(earnings = sum(WAGES)) %>% 
      select(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term, earnings) %>%
      group_by(PROGRAM_NAME, aw_year) %>% 
      ggplot() + 
      geom_density(aes(x= earnings, color = PROGRAM_NAME)) +
      labs(x = "Density", 
           y = "Earnings distribution", 
           title = "12-24 Month Earnings", 
           color = "Program") + 
      xlim(0, 100000) + 
    facet_wrap(~DEGREE_CODE)}
    )
  
  # need to select unique awards, don't double count becasue of wage data.
  output$plot_ts <- renderPlot({
    df2() %>% filter(TERM_CODE > 200940) %>%
      filter(YEAR_QUARTER == wage4) %>%
      group_by(aw_year, PROGRAM_NAME) %>% 
      tally() %>%
      ggplot() + 
      geom_line(aes(x=as.numeric(aw_year), y=n, color = PROGRAM_NAME)) +
      geom_point(aes(x=as.numeric(aw_year), y=n, color = PROGRAM_NAME)) +
      ggtitle("Number of Awards by program") +
      xlab("Year (calendar)") + 
      ylab("Number of Awards") + 
      scale_color_discrete(name="Program")}
    )
  
  output$wage_ts <- renderPlot({
    df2() %>% filter(TERM_CODE > 201020) %>%
      filter(YEAR_QUARTER == wage1 | YEAR_QUARTER == wage2 | YEAR_QUARTER == wage3 | YEAR_QUARTER == wage4) %>% 
      group_by(PIDM) %>%
      filter(max(YEAR_QUARTER) >= wage4) %>%
      group_by(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term) %>%
      summarise(earnings = sum(WAGES)) %>% 
      select(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term, earnings) %>%
      group_by(PROGRAM_NAME, aw_year) %>% 
      summarise(n = n(), med_earn = median(earnings)) %>%
      ggplot() + 
      geom_line(aes(as.numeric(aw_year), y=med_earn, col = PROGRAM_NAME)) + 
      geom_point(aes(as.numeric(aw_year), y=med_earn, col = PROGRAM_NAME)) + 
      scale_color_discrete(name="Program") +
      labs(x = "Wages for award year", 
           y = "12-24 month post-award wages", 
           title = "Median wages by year", 
           size = "Number of records")}
    )
  
    output$table <- renderTable({
      df2() %>% filter(TERM_CODE > 201020) %>%
        filter(YEAR_QUARTER == wage1 | YEAR_QUARTER == wage2 | YEAR_QUARTER == wage3 | YEAR_QUARTER == wage4) %>% 
        group_by(PIDM) %>%
        filter(max(YEAR_QUARTER) >= wage4) %>%
        group_by(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term) %>%
        summarise(earnings = sum(WAGES)) %>% 
        select(PIDM, PROGRAM_NAME, DEGREE_CODE, TERM_CODE, aw_year, aw_term, earnings) %>%
        group_by(PROGRAM_NAME, aw_year) %>% 
        summarise('Median earnings' = median(earnings),
              '25%' = quantile(earnings, 0.25),
              '75%' = quantile(earnings, 0.75),
              students = n_distinct(PIDM)
              ) %>%
        rename("Program name" = PROGRAM_NAME, "Award year" = aw_year)
      })
    
}
# Run the application 
shinyApp(ui = ui, server = server, options = list(height = 750))
```

## Data and Methodology notes

The data in this project are collected from Banner and the State of Utah's Department of Workforce Services (DWS). The DWS data is requested and updated regularly every semester. The DWS data is derived from State mandated employer surveys. The DWS data should provide accurate and wide coverage of SLCC graduates working in the State of Utah for private businesses. It will however not provide information on students who are self-employed, entrepreneurs, working for a religious or non-profit organizations, some federal government employees (military for example) and provides no information on the actual job the student has or periods of unemployment. Former students choosing to work seasonally or part time are not flagged in this data since work hours are not provided along with quarterly wages by employers to DWS.

The students in this project have no history of transfer to another institution following their SLCC award. This data is meant to represent those students who complete a CTE award and immediately go into the workforce and not those who go on to complete more schooling or do not go into the workforce at all. 


